<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Keuangan Pribadoy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Gaya CSS Kustom (jika diperlukan) */
        .transaksi-positif {
            color: #16a34a; /* Tailwind green-600 */
        }
        .transaksi-negatif {
            color: #dc2626; /* Tailwind red-600 */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            overflow-x: auto; /* Tambahkan scroll horizontal jika perlu */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
             /* Tambahkan animasi hover pada th */
            transition: background-color 0.3s ease;
        }
        th:hover {
            background-color: #e0e0e0; /* Warna latar belakang saat dihover */
        }

        td {
             /* Tambahkan animasi hover pada td */
            transition: background-color 0.3s ease;
        }
        td:hover {
            background-color: #f8f8f8;
        }
        .detail-transaksi {
            background-color: #e0f2fe; /* Tailwind blue-100 */
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid #b0e0fe; /* Tailwind blue-200 */
        }

        /* Media query untuk layar kecil */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            th, td {
                display: table-cell;
                vertical-align: top;
            }
            th {
                /*background-color: #f0f0f0;*/
            }
            /* Tambahkan gaya lain yang diperlukan untuk layar kecil */
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr); /*ubah jadi 2 kolom*/
            }
            #section-tambah-transaksi .grid{
                display: flex;
                flex-direction: column;
            }
            #section-tambah-transaksi label{
                margin-top: 10px;
            }
            #section-filter-transaksi .grid{
                display: flex;
                flex-direction: column;
            }
            #section-filter-transaksi label{
                margin-top: 10px;
            }
        }

        /* Animasi untuk tombol */
        .animated-button {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Animasi untuk elemen yang muncul */
        .fade-in {
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .icon-animation {
            animation: spin 2s linear infinite;
            display: inline-block; /* Memastikan ikon diperlakukan seperti elemen inline */
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        /* Gaya untuk Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .pagination button:hover {
            background-color: #f0f0f0;
        }
        .pagination button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .pagination button:disabled {
            background-color: #ddd;
            color: #aaa;
            cursor: not-allowed;
            border-color: #ddd;
        }

    </style>
</head>
<body class="bg-gray-100 font-inter">
    <div class="container mx-auto p-6 bg-white rounded-lg shadow-md mt-10 fade-in">
       <h1 class="text-4xl font-bold text-center text-indigo-700 mb-2 icon-animation">ðŸ’¸ Aplikasi CADAS</h1>
        <h3 class="text-xl font-medium text-center text-gray-600 mb-8">Catat Duit Adi Sudrajat</h3>

        <div id="section-login" class="bg-gray-100 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4"><i class="fas fa-sign-in-alt mr-2"></i> Login</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" placeholder="Masukkan email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" placeholder="Masukkan password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
                </div>
            </div>
            <div class="mt-6">
                <button id="login-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline animated-button">
                    <i class="fas fa-lock mr-2"></i> Login
                </button>
            </div>
            <div id="error-message" class="text-red-500 text-xs italic mt-4" style="display: none;"></div>
             <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-info-circle mr-1"></i>
                <b>Pengingat:</b> Selalu catat setiap transaksi Anda agar keuangan Anda terkontrol dengan baik.
            </p>
        </div>




        <div id="section-logout" class="bg-gray-100 rounded-lg p-6 mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4"><i class="fas fa-sign-out-alt mr-2"></i> Logout</h2>
            <p class="text-gray-800 mb-4">Anda telah login. Klik tombol di bawah untuk logout.</p>
            <button id="logout-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline animated-button">
                <i class="fas fa-door-open mr-2"></i> Logout
            </button>
             <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-check-circle mr-1"></i>
                <b>Motivasi:</b> "Setiap pengeluaran yang dicatat adalah langkah menuju kebebasan finansial."
            </p>





<div class="text-right">
  <a href="https://portofolioadi.vercel.app" target="_blank">
       <p class="text-gray-800 mb-4">Silakan kunjungi website potofolio Anda</p>
    <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline animated-button">
      WEBSITE PORTOFOLIO ANDA
    </button>
  </a>
</div>

        </div>

        <div id="section-saldo" class="bg-indigo-100 rounded-lg p-4 mb-6" style="display: none;">
            <h2 class="text-xl font-semibold text-indigo-700 mb-2"><i class="fas fa-wallet mr-2"></i> Saldo Anda</h2>
            <p id="total-saldo" class="text-2xl font-bold text-gray-800">Rp 0</p>
             <p class="mt-2 text-gray-600 text-sm">
                <i class="fas fa-money-check-alt mr-1"></i>
                <b>Motivasi:</b> "Saldo yang bertambah adalah hasil dari kedisiplinan dan perencanaan yang baik."
            </p>
        </div>

        <div id="section-tambah-transaksi" class="bg-yellow-100 rounded-lg p-6 mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold text-yellow-700 mb-4"><i class="fas fa-plus-circle mr-2"></i> Tambah Transaksi</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <label for="tanggal" class="block text-gray-700 text-sm font-bold mb-2">Tanggal:</label>
                <input type="date" id="tanggal" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />

                <label for="jenis" class="block text-gray-700 text-sm font-bold mb-2">Jenis:</label>
                <select id="jenis" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="pendapatan">Pendapatan</option>
                    <option value="pengeluaran">Pengeluaran</option>
                </select>

                <label for="kategori" class="block text-gray-700 text-sm font-bold mb-2">Kategori:</label>
                <input type="text" id="kategori" placeholder="Makanan, Transport..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />

                <label for="jumlah" class="block text-gray-700 text-sm font-bold mb-2">Jumlah:</label>
                <input type="number" id="jumlah" placeholder="Masukkan jumlah" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>
            <div class="mt-6">
                <button id="tambah-transaksi" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline animated-button">
                    <i class="fas fa-plus mr-2"></i> Tambah Transaksi
                </button>
            </div>
             <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-lightbulb mr-1"></i>
                <b>Tips:</b> Selalu kategorikan transaksi Anda untuk analisis yang lebih baik.
            </p>
        </div>

        <div id="section-filter-transaksi" class="bg-purple-100 rounded-lg p-6 mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold text-purple-700 mb-4"><i class="fas fa-filter mr-2"></i> Filter Transaksi</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="filter-bulan" class="block text-gray-700 text-sm font-bold mb-2">Filter Bulan:</label>
                    <select id="filter-bulan" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Semua Bulan</option>
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                <div>
                    <label for="filter-tahun" class="block text-gray-700 text-sm font-bold mb-2">Filter Tahun:</label>
                    <select id="filter-tahun" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Semua Tahun</option>
                    </select>
                </div>
                <div>
                    <label for="filter-kategori" class="block text-gray-700 text-sm font-bold mb-2">Filter Kategori:</label>
                    <input type="text" id="filter-kategori" placeholder="Cari Kategori" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
                </div>
            </div>
             <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-search mr-1"></i>
                <b>Pengingat:</b> Gunakan filter untuk melihat riwayat transaksi Anda dengan lebih mudah.
            </p>
        </div>

        <div id="section-daftar-transaksi" class="bg-green-100 rounded-lg p-6 mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold text-green-700 mb-4"><i class="fas fa-list-ul mr-2"></i> Daftar Transaksi</h2>
            <div class="overflow-x-auto">
                <table id="daftar-transaksi" class="min-w-full leading-normal shadow-md rounded-lg overflow-hidden">
                    <thead class="bg-gray-200 text-gray-700">
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">Tanggal</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">Jenis</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">Kategori</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 text-right text-xs font-semibold uppercase tracking-wider">Jumlah</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        <tr>
                            <td colspan="5" class="px-5 py-5 border-b border-gray-200 text-sm">Tidak ada transaksi.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
    <button id="prev-page" disabled>Previous</button>
    <button id="next-page">Next</button>
</div>


            <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-history mr-1"></i>
                <b>Motivasi:</b> "Setiap transaksi adalah bagian dari cerita keuangan Anda. Catat dengan baik!"
            </p>

        <div id="section-summary" class="bg-red-100 rounded-lg p-6 mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold text-red-700 mb-4"><i class="fas fa-chart-pie mr-2"></i> Ringkasan</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700">Total Pendapatan:</h3>
                    <p id="total-pendapatan" class="text-xl font-bold text-green-600">Rp 0</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700">Total Pengeluaran:</h3>
                    <p id="total-pengeluaran" class="text-xl font-bold text-red-600">Rp 0</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700">Saldo Akhir:</h3>
                    <p id="saldo-akhir" class="text-xl font-bold text-blue-600">Rp 0</p>
                </div>
            </div>
            <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-chart-line mr-1"></i>
                <b>Motivasi:</b> "Ringkasan ini membantu Anda melihat gambaran besar keuangan Anda."
            </p>
        </div>

        <div class="text-center mt-6">
            <button id="cetak-pdf" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline animated-button">
                <i class="fas fa-print mr-2"></i> Cetak
            </button>
            <p class="mt-4 text-gray-600 text-sm">
                <i class="fas fa-file-pdf mr-1"></i>
                <b>Pengingat:</b> Cetak laporan untuk dokumentasi fisik dan perencanaan di masa mendatang.
            </p>
        </div>
    </div>

    <footer class="copyright">
        &copy; 2024 Adi Sudrajat. All rights reserved.
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDvf_Rg89uX9ODamiUjTCZ-ZTIYA2C7a7w",
            authDomain: "keuanganadi.firebaseapp.com",
            projectId: "keuanganadi",
            storageBucket: "keuanganadi.firebasestorage.app",
            messagingSenderId: "829317955644",
            appId: "1:829317955644:web:ecd350db338c02ab0fc339",
            measurementId: "G-WDNBRP6DB5"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Data transaksi (sementara, akan disimpan di localStorage setelah login)
        let transaksi = [];
        let isLoggedIn = false;
        let userEmail = "";
        let selectedTransaksiId = null;
        const recordsPerPage = 5; // Jumlah transaksi per halaman
        let currentPage = 1;

        // Mendapatkan elemen-elemen HTML
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loginSection = document.getElementById('section-login');
        const logoutSection = document.getElementById('section-logout');
        const saldoSection = document.getElementById('section-saldo');
        const tambahTransaksiSection = document.getElementById('section-tambah-transaksi');
        const filterTransaksiSection = document.getElementById('section-filter-transaksi');
        const daftarTransaksiTable = document.getElementById('daftar-transaksi');
        const summarySection = document.getElementById('section-summary');
        const cetPdfButton = document.getElementById('cetak-pdf');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const tanggalInput = document.getElementById('tanggal');
        const jenisInput = document.getElementById('jenis');
        const kategoriInput = document.getElementById('kategori');
        const jumlahInput = document.getElementById('jumlah');
        const tambahTransaksiButton = document.getElementById('tambah-transaksi');
        const totalSaldoElement = document.getElementById('total-saldo');
        const totalPendapatanElement = document.getElementById('total-pendapatan');
        const totalPengeluaranElement = document.getElementById('total-pengeluaran');
        const saldoAkhirElement = document.getElementById('saldo-akhir');
        const filterBulanInput = document.getElementById('filter-bulan');
        const filterTahunInput = document.getElementById('filter-tahun');
        const filterKategoriInput = document.getElementById('filter-kategori');
        const detailTransaksiDiv = document.getElementById('detail-transaksi');
        const detailTanggalElement = document.getElementById('detail-tanggal');
        const detailJenisElement = document.getElementById('detail-jenis');
        const detailKategoriElement = document.getElementById('detail-kategori');
        const detailJumlahElement = document.getElementById('detail-jumlah');
        const hapusTransaksiButton = document.getElementById('hapus-transaksi');

        // Fungsi untuk menampilkan atau menyembunyikan bagian-bagian aplikasi
        function toggleSections() {
            if (isLoggedIn) {
                loginSection.style.display = 'none';
                logoutSection.style.display = 'block';
                saldoSection.style.display = 'block';
                tambahTransaksiSection.style.display = 'block';
                filterTransaksiSection.style.display = 'block';
                daftarTransaksiTable.parentElement.parentElement.style.display = 'block';
                summarySection.style.display = 'block';
                cetPdfButton.parentElement.style.display = 'block';
                prevPageButton.parentElement.style.display = 'flex'; //memastikan tombol navigasi selalu flex
            } else {
                loginSection.style.display = 'block';
                logoutSection.style.display = 'none';
                saldoSection.style.display = 'none';
                tambahTransaksiSection.style.display = 'none';
                filterTransaksiSection.style.display = 'none';
                daftarTransaksiTable.parentElement.parentElement.style.display = 'none';
                summarySection.style.display = 'none';
                cetPdfButton.parentElement.style.display = 'none';
                prevPageButton.parentElement.style.display = 'none';
            }
        }

        // Event listener untuk tombol login
        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    userEmail = user.email;
                    isLoggedIn = true;
                    // Simpan data user ke localStorage
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userEmail', userEmail);
                    // Load transaksi dari localStorage
                    loadTransaksiFromLocalStorage();
                    updateTahunOptions();
                    toggleSections();
                    updateSaldo();
                    Swal.fire({
                        icon: 'success',
                        title: 'Login Berhasil!',
                        text: `Selamat datang, ${userEmail}!`,
                    });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessageText = error.message;
                    errorMessage.textContent = errorMessageText;
                    errorMessage.style.display = 'block';
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Gagal!',
                        text: errorMessageText,
                    });
                });
        });

        // Event listener untuk tombol logout
        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                // Sign-out successful.
                isLoggedIn = false;
                userEmail = "";
                transaksi = [];
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('transaksi');
                toggleSections();
                Swal.fire({
                    icon: 'success',
                    title: 'Logout Berhasil!',
                    text: 'Anda telah berhasil logout.',
                });
            }).catch((error) => {
                // An error happened.
                const errorMessageText = error.message;
                 Swal.fire({
                        icon: 'error',
                        title: 'Logout Gagal!',
                        text: errorMessageText,
                    });
            });

        });

        // Fungsi untuk menyimpan transaksi ke localStorage
        function saveTransaksiToLocalStorage() {
            if (isLoggedIn) {
                localStorage.setItem('transaksi', JSON.stringify(transaksi));
            }
        }

        // Fungsi untuk memuat transaksi dari localStorage
        function loadTransaksiFromLocalStorage() {
            if (isLoggedIn) {
                const transaksiData = localStorage.getItem('transaksi');
                if (transaksiData) {
                    transaksi = JSON.parse(transaksiData);
                } else {
                    transaksi = [];
                }
            }
        }

        // Fungsi untuk menambahkan transaksi baru
        tambahTransaksiButton.addEventListener('click', () => {
            const tanggal = tanggalInput.value;
            const jenis = jenisInput.value;
            const kategori = kategoriInput.value;
            const jumlah = parseFloat(jumlahInput.value);

            if (!tanggal || !jenis || !kategori || isNaN(jumlah)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Input Tidak Valid!',
                    text: 'Harap isi semua kolom dengan benar.',
                });
                return;
            }

            const transaksiBaru = {
                id: Date.now(), // Gunakan timestamp sebagai ID unik
                tanggal: tanggal,
                jenis: jenis,
                kategori: kategori,
                jumlah: jumlah,
                email: userEmail // Tambahkan email user yang sedang login
            };

            transaksi.push(transaksiBaru);
            saveTransaksiToLocalStorage();
            updateTahunOptions();
            updateSaldo();
            renderTransaksi(currentPage); // Render halaman saat ini
            clearForm();

            Swal.fire({
                icon: 'success',
                title: 'Transaksi Berhasil Ditambahkan!',
                text: 'Data transaksi Anda telah disimpan.',
            });
        });

        // Fungsi untuk membersihkan form setelah menambahkan transaksi
        function clearForm() {
            tanggalInput.value = '';
            jenisInput.value = 'pendapatan';
            kategoriInput.value = '';
            jumlahInput.value = '';
        }

        // Fungsi untuk menghitung dan menampilkan saldo
        function updateSaldo() {
            let totalPendapatan = 0;
            let totalPengeluaran = 0;

             // Filter transaksi berdasarkan email user yang login
            const userTransaksi = transaksi.filter(t => t.email === userEmail);

            userTransaksi.forEach(transaksi => {
                if (transaksi.jenis === 'pendapatan') {
                    totalPendapatan += transaksi.jumlah;
                } else {
                    totalPengeluaran += transaksi.jumlah;
                }
            });

            const saldoAkhir = totalPendapatan - totalPengeluaran;

            totalPendapatanElement.textContent = `Rp ${totalPendapatan.toLocaleString('id-ID')}`;
            totalPengeluaranElement.textContent = `Rp ${totalPengeluaran.toLocaleString('id-ID')}`;
            saldoAkhirElement.textContent = `Rp ${saldoAkhir.toLocaleString('id-ID')}`;
            totalSaldoElement.textContent = `Rp ${saldoAkhir.toLocaleString('id-ID')}`;
        }

        // Fungsi untuk menampilkan daftar transaksi
        function renderTransaksi(page) {
            const startIndex = (page - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;

             // Filter transaksi berdasarkan email user yang login
             const userTransaksi = transaksi.filter(t => t.email === userEmail);
            const transaksiYangAkanDitampilkan = userTransaksi; // Tidak perlu di-slice lagi, sudah difilter

            daftarTransaksiTable.querySelector('tbody').innerHTML = ''; // Clear table

            if (transaksiYangAkanDitampilkan.length === 0) {
                daftarTransaksiTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="px-5 py-5 border-b border-gray-200 text-sm">Tidak ada transaksi.</td></tr>';
                prevPageButton.disabled = true;
                nextPageButton.disabled = true;
            } else {
                transaksiYangAkanDitampilkan.forEach(transaksi => {
                    const row = document.createElement('tr');
                    const tanggalFormatted = new Date(transaksi.tanggal).toLocaleDateString('id-ID');
                    row.innerHTML = `
                        <td class="px-5 py-5 border-b border-gray-200 text-sm"><span class="font-italic text-gray-800">${tanggalFormatted}</span></td>
                        <td class="px-5 py-5 border-b border-gray-200 text-sm"><span class="${transaksi.jenis === 'pendapatan' ? 'transaksi-positif' : 'transaksi-negatif'} font-semibold">${transaksi.jenis}</span></td>
                        <td class="px-5 py-5 border-b border-gray-200 text-sm"><span class="font-medium text-indigo-600">${transaksi.kategori}</span></td>
                        <td class="px-5 py-5 border-b border-gray-200 text-right text-sm"><span class="font-bold text-gray-900">Rp ${transaksi.jumlah.toLocaleString('id-ID')}</span></td>
                         <td class="px-5 py-5 border-b border-gray-200 text-sm">
                            <button class="detail-button bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs mr-1" data-id="${transaksi.id}">
                                <i class="fas fa-info-circle"></i> Detail
                            </button>
                            <button class="edit-button bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs mr-1" data-id="${transaksi.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="delete-button bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" data-id="${transaksi.id}">
                                <i class="fas fa-trash-alt"></i> Hapus
                            </button>
                        </td>
                    `;
                    daftarTransaksiTable.querySelector('tbody').appendChild(row);
                });

                prevPageButton.disabled = page === 1;
                nextPageButton.disabled = endIndex >= transaksiYangAkanDitampilkan.length;
            }
        }

        // Event listener untuk tombol "Detail"
        daftarTransaksiTable.addEventListener('click', (event) => {
            if (event.target.classList.contains('detail-button')) {
                const transaksiId = parseInt(event.target.dataset.id);
                const transaksiYangDipilih = transaksi.find(t => t.id === transaksiId && t.email === userEmail); //filter juga berdasarkan email

                if (transaksiYangDipilih) {
                    selectedTransaksiId = transaksiId; // Simpan ID transaksi yang sedang dilihat
                    detailTanggalElement.textContent = new Date(transaksiYangDipilih.tanggal).toLocaleDateString('id-ID');
                    detailJenisElement.textContent = transaksiYangDipilih.jenis;
                    detailKategoriElement.textContent = transaksiYangDipilih.kategori;
                    detailJumlahElement.textContent = `Rp ${transaksiYangDipilih.jumlah.toLocaleString('id-ID')}`;
                    // Tambahkan logika untuk menampilkan detail transaksi (misalnya, menggunakan modal)
                    Swal.fire({
                        title: 'Detail Transaksi',
                        html: `<div class="detail-transaksi">
                                    <p><strong>Tanggal:</strong> ${detailTanggalElement.textContent}</p>
                                    <p><strong>Jenis:</strong> ${detailJenisElement.textContent}</p>
                                    <p><strong>Kategori:</strong> ${detailKategoriElement.textContent}</p>
                                    <p><strong>Jumlah:</strong> ${detailJumlahElement.textContent}</p>
                                </div>`,
                        showCloseButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'Edit',
                        cancelButtonText: 'Hapus',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Handle Edit
                            handleEdit(transaksiId);
                        } else if (result.dismiss === Swal.DismissReason.cancel) {
                            // Handle Delete
                            handleDelete(transaksiId);
                        }
                    });
                }
            }
        });

        function handleEdit(transaksiId) {
             const transaksiYangDipilih = transaksi.find(t => t.id === transaksiId && t.email === userEmail);
            if (transaksiYangDipilih) {
                tanggalInput.value = transaksiYangDipilih.tanggal;
                jenisInput.value = transaksiYangDipilih.jenis;
                kategoriInput.value = transaksiYangDipilih.kategori;
                jumlahInput.value = transaksiYangDipilih.jumlah;

                // Hapus transaksi lama dari array
                transaksi = transaksi.filter(t => t.id !== transaksiId);
                saveTransaksiToLocalStorage();
                renderTransaksi(currentPage);

                 Swal.fire({
                    icon: 'info',
                    title: 'Silakan ubah data transaksi',
                    text: 'Klik tombol Tambah Transaksi setelah mengubah data',
                });
            }
        }

        function handleDelete(transaksiId) {
            Swal.fire({
                title: 'Apakah Anda yakin?',
                text: "Anda tidak akan dapat mengembalikan transaksi ini!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, hapus!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    transaksi = transaksi.filter(t => t.id !== transaksiId && t.email !== userEmail);
                    saveTransaksiToLocalStorage();
                    updateSaldo();
                    renderTransaksi(currentPage);
                    Swal.fire(
                        'Terhapus!',
                        'Transaksi Anda telah dihapus.',
                        'success'
                    );
                }
            });
        }

        // Event listener untuk tombol "Hapus"
        daftarTransaksiTable.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-button')) {
                const transaksiId = parseInt(event.target.dataset.id);
                handleDelete(transaksiId);
            }
        });

         // Event listener untuk tombol "Edit"
        daftarTransaksiTable.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-button')) {
                const transaksiId = parseInt(event.target.dataset.id);
                handleEdit(transaksiId);
            }
        });

        // Fungsi untuk inisialisasi filter tahun
        function updateTahunOptions() {
            const tahunSet = new Set();
             // Filter transaksi berdasarkan email user yang login
            const userTransaksi = transaksi.filter(t => t.email === userEmail);
            userTransaksi.forEach(transaksi => {
                const tahun = new Date(transaksi.tanggal).getFullYear();
                tahunSet.add(tahun);
            });

            filterTahunInput.innerHTML = '<option value="">Semua Tahun</option>'; // Clear existing options
            const sortedTahun = Array.from(tahunSet).sort((a, b) => b - a); // Sort descending
            sortedTahun.forEach(tahun => {
                const option = document.createElement('option');
                option.value = tahun;
                option.textContent = tahun;
                filterTahunInput.appendChild(option);
            });
        }

        // Event listener untuk filter
        filterBulanInput.addEventListener('change', () => {
            currentPage = 1;
            renderTransaksi(currentPage);
        });
        filterTahunInput.addEventListener('change', () => {
            currentPage = 1;
            renderTransaksi(currentPage);
        });
        filterKategoriInput.addEventListener('input', () => {
            currentPage = 1;
            renderTransaksi(currentPage);
        });

        // Fungsi untuk memfilter transaksi
        function filterTransaksi() {
            const bulan = filterBulanInput.value;
            const tahun = filterTahunInput.value;
            const kategori = filterKategoriInput.value.toLowerCase();

            // Filter transaksi berdasarkan email user yang login
            const userTransaksi = transaksi.filter(t => t.email === userEmail);

            const filteredTransaksi = userTransaksi.filter(transaksi => {
                const transaksiBulan = bulan === '' || new Date(transaksi.tanggal).getMonth() === parseInt(bulan);
                const transaksiTahun = tahun === '' || new Date(transaksi.tanggal).getFullYear() === parseInt(tahun);
                const transaksiKategori = kategori === '' || transaksi.kategori.toLowerCase().includes(kategori);
                return transaksiBulan && transaksiTahun && transaksiKategori;
            });
            return filteredTransaksi;
        }

        // Event listener untuk cetak PDF
        cetPdfButton.addEventListener('click', () => {
            const doc = new jsPDF();
            doc.text("Laporan Transaksi Keuangan", 10, 10);

            const filteredTransaksi = filterTransaksi(); // Gunakan fungsi filterTransaksi

            let y = 20;
            filteredTransaksi.forEach(transaksi => {
                const tanggal = new Date(transaksi.tanggal).toLocaleDateString('id-ID');
                doc.text(`Tanggal: ${tanggal}, Jenis: ${transaksi.jenis}, Kategori: ${transaksi.kategori}, Jumlah: Rp ${transaksi.jumlah.toLocaleString('id-ID')}`, 10, y);
                y += 10;
            });

            // Tambahkan ringkasan
            doc.text(`Total Pendapatan: ${totalPendapatanElement.textContent}`, 10, y += 10);
            doc.text(`Total Pengeluaran: ${totalPengeluaranElement.textContent}`, 10, y += 10);
            doc.text(`Saldo Akhir: ${saldoAkhirElement.textContent}`, 10, y += 10);

            doc.save('laporan-transaksi.pdf');
        });

        // Fungsi untuk menampilkan ringkasan transaksi
        function updateSummary() {
            let totalPendapatan = 0;
            let totalPengeluaran = 0;

             // Filter transaksi berdasarkan email user yang login
            const userTransaksi = transaksi.filter(t => t.email === userEmail);
            const filteredTransaksi = filterTransaksi(); // Gunakan hasil filter

            filteredTransaksi.forEach(transaksi => { // Gunakan filteredTransaksi
                if (transaksi.jenis === 'pendapatan') {
                    totalPendapatan += transaksi.jumlah;
                } else {
                    totalPengeluaran += transaksi.jumlah;
                }
            });

            const saldoAkhir = totalPendapatan - totalPengeluaran;

            totalPendapatanElement.textContent = `Rp ${totalPendapatan.toLocaleString('id-ID')}`;
            totalPengeluaranElement.textContent = `Rp ${totalPengeluaran.toLocaleString('id-ID')}`;
            saldoAkhirElement.textContent = `Rp ${saldoAkhir.toLocaleString('id-ID')}`;
        }

        // Event listener untuk pagination
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTransaksi(currentPage);
            }
        });

        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(transaksi.length / recordsPerPage); //hitung ulang totalPages
            if (currentPage < totalPages) {
                currentPage++;
                renderTransaksi(currentPage);
            }
        });

        // Fungsi inisialisasi
        function init() {
            // Cek apakah user sudah login
            const storedIsLoggedIn = localStorage.getItem('isLoggedIn');
            const storedUserEmail = localStorage.getItem('userEmail');

            if (storedIsLoggedIn === 'true' && storedUserEmail) {
                isLoggedIn = true;
                userEmail = storedUserEmail;
                loadTransaksiFromLocalStorage();
            }
            toggleSections();
            updateTahunOptions();
            updateSaldo();
            renderTransaksi(currentPage); //tampilkan page 1 saat pertama kali load
        }

        init(); // Panggil fungsi inisialisasi
    </script>
</body>
</html>
